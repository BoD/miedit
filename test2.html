<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Sprite âˆ’ MiEdit</title>
    <link rel="stylesheet" href="library/bootstrap4/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <div>
      <h1>Test editor</h1>
      <form>
        <textarea class="minitel-mosaic"></textarea>
      </form>
    </div>

    <script src="library/jquery/jquery.js"></script>

<style>
.mosaic-root {
    position: relative;
    background-color: black;
    display: inline-block;
}
.mosaic-background {
}

.mosaic-drawing, .mosaic-grid {
    position: absolute;
    top: 0;
    left: 0;
}
</style>

    <script>
"use strict"

const minitelColors = [
    "#000000", // black
    "#FF0000", // red
    "#00FF00", // green
    "#FFFF00", // yellow
    "#0000FF", // blue
    "#FF00FF", // magenta
    "#00FFFF", // cyan
    "#FFFFFF", // white
]

class MinitelMosaic {
    constructor(textarea, zoom) {
        this.width = 320
        this.height = 240
        this.zoom = zoom
        this.isDrawing = false
        this.previous = { x: undefined, y: undefined }
        this.lastpoint = { x: undefined, y: undefined }

        this.color = 7
        this.separated = true

        this.root = document.createElement("div")
        this.root.className = "mosaic-root"

        this.createDOMElements()

        document.body.appendChild(this.root)

        this.drawGrid()
        this.drawBackground()

        this.drawing.addEventListener("mouseup", e => this.onMouseUp(e))
        this.drawing.addEventListener("mousedown", e => this.onMouseDown(e))
        this.drawing.addEventListener("mousemove", e => this.onMouseMove(e))

        for(let obj of this.root.getElementsByClassName("mosaic-color")) {
            obj.addEventListener("click", e => this.onColorChange(e))
        }
    }

    onColorChange(event) {
        event.preventDefault()
        this.color = event.target.value
        if(this.color !== "transparent") this.color = parseInt(this.color)
    }

    onMouseUp(event) {
        event.preventDefault()
        this.isDrawing = false
    }

    onMouseDown(event) {
        event.preventDefault()
        const point = this.translate(event)
        this.isDrawing = true
        
        if(event.shiftKey) {
            this.drawLine(this.lastPoint, point, this.color)
        } else {
            this.drawLine(this.previous, point, this.color)
        }

        this.lastPoint = { x: point.x, y: point.y }
    }

    onMouseMove(event) {
        event.preventDefault()

        const point = this.translate(event)

        if(this.isDrawing) {
            this.drawLine(this.previous, point, this.color)
            this.lastPoint = { x: point.x, y: point.y }
        }

        this.previous = { x: point.x, y: point.y }
    }

    translate(event) {
        const rect = this.drawing.getBoundingClientRect()
        const charWidth = 8 * this.zoom / 2
        const charHeight = 10 * this.zoom / 3
        const col = Math.floor((event.clientX - rect.left) / charWidth)
        const row = Math.floor((event.clientY - rect.top) / charHeight)

        return({ "x": col, "y": row })
    }

    createDOMElements() {
        this.root.innerHTML = `
            <canvas class="mosaic-background"></canvas>
            <canvas class="mosaic-drawing"></canvas>
            <canvas class="mosaic-grid"></canvas>
            <div class="mosaic-colors">
                <button class="mosaic-color" value="transparent">
                    <img src="icon/color-bg-transparent.svg" /><br/>
                    Transparent
                </button>
                <button class="mosaic-color" value="0">
                    <img src="icon/color-bg-0.svg" /><br/>Black / 0%
                </button>
                <button class="mosaic-color" value="4">
                    <img src="icon/color-bg-4.svg" /><br/>Blue / 40%
                </button>
                <button class="mosaic-color" value="1">
                    <img src="icon/color-bg-1.svg" /><br/>Red / 50%
                </button>
                <button class="mosaic-color" value="5">
                    <img src="icon/color-bg-5.svg" /><br/>Magenta / 60%
                </button>
                <button class="mosaic-color" value="2">
                    <img src="icon/color-bg-2.svg" /><br/>Green / 70%
                </button>
                <button class="mosaic-color" value="6">
                    <img src="icon/color-bg-6.svg" /><br/>Cyan / 80%
                </button>
                <button class="mosaic-color" value="3">
                    <img src="icon/color-bg-3.svg" /><br/>Yellow / 90%
                </button>
                <button class="mosaic-color" value="7">
                    <img src="icon/color-bg-7.svg" /><br/>White / 40%
                </button>
            </div>
        `

        this.background = this.root.getElementsByClassName("mosaic-background")[0]
        this.drawing = this.root.getElementsByClassName("mosaic-drawing")[0]
        this.grid = this.root.getElementsByClassName("mosaic-grid")[0]
        this.grid.style = "pointer-events: none"

        for(let obj of [ this.background, this.drawing, this.grid ]) {
            obj.width  = this.width * this.zoom
            obj.height = this.height * this.zoom
            const ctx = obj.getContext("2d")
            ctx.scale(this.zoom, this.zoom)
        }
    }

    convertCoordinates(x, y) {
        const coords = {}

        coords.x = x * 4
        coords.width = 4
        coords.y = Math.floor(y / 3) * 10
        switch(y % 3) {
            case 0:
                coords.height = 3
                break
            case 1:
                coords.y += 3
                coords.height = 4
                break
            case 2:
                coords.y += 7
                coords.height = 3
                break
        }

        if(this.separated && this.color !== "transparent") {
            coords.width--
            coords.height--
            coords.x++
        }

        return coords
    }

    drawPoint(x, y, color) {
        const ctx = this.drawing.getContext("2d")
        const coords = this.convertCoordinates(x, y)

        if(color === "transparent") {
            ctx.clearRect(coords.x, coords.y, coords.width, coords.height)
        } else {
            ctx.fillStyle = minitelColors[color]
            ctx.fillRect(coords.x, coords.y, coords.width, coords.height)
        }
    }

    drawLine(first, last, color) {
        let x0 = first.x
        let y0 = first.y
        let x1 = last.x
        let y1 = last.y
        const dx = Math.abs(x1 - x0)
        const dy = Math.abs(y1 - y0)
        const sx = (x0 < x1) ? 1 : -1
        const sy = (y0 < y1) ? 1 : -1
        let err = dx - dy

        while(true){
            this.drawPoint(x0, y0, color)

            if(x0 === x1 && y0 === y1) break
            var e2 = 2 * err
            if(e2 > -dy) {
                err -= dy
                x0 += sx
            }

            if(e2 < dx) {
                err += dx
                y0 += sy
            }
        }
    }

    drawBackground() {
        const skew = 500
        const inc = 20

        const ctx = this.background.getContext("2d")
        ctx.lineWidth = 10 / this.zoom
        ctx.strokeStyle = "#202020"
        ctx.beginPath()
        for(let x = -skew; x < this.width; x += inc) {
            ctx.moveTo(x, 0)
            ctx.lineTo(x + skew, this.height)
        }
        ctx.stroke()
        ctx.closePath()
    }

    drawGrid() {
        const ctx = this.grid.getContext("2d")

        ctx.beginPath()

        ctx.lineWidth = 1 / this.zoom
        ctx.imageSmoothingEnabled = false
        ctx.mozImageSmoothingEnabled = false

        ctx.strokeStyle = "#404000"
        for(let x = 4; x < this.width; x+= 8) {
            ctx.moveTo(x, 0)
            ctx.lineTo(x, this.height)
        }

        for(let y = 0; y < this.height; y+= 10) {
            ctx.moveTo(0, y + 3)
            ctx.lineTo(this.width, y + 3)
            ctx.moveTo(0, y + 7)
            ctx.lineTo(this.width, y + 7)
        }

        ctx.stroke()
        ctx.closePath()

        ctx.beginPath()
        ctx.strokeStyle = "#808000"
        for(let x = 0; x < this.width; x+= 8) {
            ctx.moveTo(x, 0)
            ctx.lineTo(x, this.height)
        }

        for(let y = 0; y < this.height; y+= 10) {
            ctx.moveTo(0, y)
            ctx.lineTo(this.width, y)
        }

        ctx.stroke()
        ctx.closePath()
    }
}

const textarea = document.getElementsByClassName("minitel-mosaic")[0]
new MinitelMosaic(textarea, 4)

    </script>
  </body>
</html>
